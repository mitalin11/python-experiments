{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 3,
   "metadata": {},
   "outputs": [],
   "source": [
    "ip = \"\"\"TRIP_ID;VEHICLE_ID;TIME_STAMP;SIGNAL_NAME;WIRELESS_CHARGING_STATE\n",
    "405f;0691e45b;1606544630505;systemEvent;NULL\n",
    "405f;0691e45b;1606544689247;WirelessChargingService,wirelessChargingStatusChanged;CHARGING\n",
    "405f;0691e45b;1606545167860;WirelessChargingService,wirelessChargingStatusChanged;NOT_CHARGING\n",
    "405f;0691e45b;1606545593799;GeneralConnectivityService,getConnectionStatus;NULL\n",
    "49e5;e7c89137;1606596766521;systemEvent;NULL\n",
    "49e5;e7c89137;1606596789849;WirelessChargingService,wirelessChargingStatusChanged;CHARGING\n",
    "49e5;e7c89137;1606596794961;WirelessChargingService,wirelessChargingStatusChanged;NOT_CHARGING\n",
    "49e5;e7c89137;1606596865073;WirelessChargingService,wirelessChargingStatusChanged;CHARGING\n",
    "49e5;e7c89137;1606599017374;ApplicationControlService,activeApplicationChanged;NULL\"\"\""
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 42,
   "metadata": {},
   "outputs": [],
   "source": [
    "row = []\n",
    "sub_row = []\n",
    "for line in ip.split(\"\\n\"):\n",
    "    sub_row = line.split(';')\n",
    "    row.append(sub_row)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 43,
   "metadata": {},
   "outputs": [],
   "source": [
    "import pandas as pd"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 44,
   "metadata": {},
   "outputs": [],
   "source": [
    "df = pd.DataFrame(row, columns=row.pop(0))"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 45,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>TRIP_ID</th>\n",
       "      <th>VEHICLE_ID</th>\n",
       "      <th>TIME_STAMP</th>\n",
       "      <th>SIGNAL_NAME</th>\n",
       "      <th>WIRELESS_CHARGING_STATE</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606544630505</td>\n",
       "      <td>systemEvent</td>\n",
       "      <td>NULL</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606544689247</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606545167860</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>NOT_CHARGING</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606545593799</td>\n",
       "      <td>GeneralConnectivityService,getConnectionStatus</td>\n",
       "      <td>NULL</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606596766521</td>\n",
       "      <td>systemEvent</td>\n",
       "      <td>NULL</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  TRIP_ID VEHICLE_ID     TIME_STAMP  \\\n",
       "0    405f   0691e45b  1606544630505   \n",
       "1    405f   0691e45b  1606544689247   \n",
       "2    405f   0691e45b  1606545167860   \n",
       "3    405f   0691e45b  1606545593799   \n",
       "4    49e5   e7c89137  1606596766521   \n",
       "\n",
       "                                         SIGNAL_NAME WIRELESS_CHARGING_STATE  \n",
       "0                                        systemEvent                    NULL  \n",
       "1  WirelessChargingService,wirelessChargingStatus...                CHARGING  \n",
       "2  WirelessChargingService,wirelessChargingStatus...            NOT_CHARGING  \n",
       "3     GeneralConnectivityService,getConnectionStatus                    NULL  \n",
       "4                                        systemEvent                    NULL  "
      ]
     },
     "execution_count": 45,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df.head()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 46,
   "metadata": {},
   "outputs": [],
   "source": [
    "from datetime import datetime"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 60,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "1606544630505"
      ]
     },
     "execution_count": 60,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "int(df.loc[0,'TIME_STAMP'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 64,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "datetime.datetime(2020, 11, 27, 22, 23, 50, 505000)"
      ]
     },
     "execution_count": 64,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "datetime.fromtimestamp(int(1606544630505)/1000)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 65,
   "metadata": {},
   "outputs": [],
   "source": [
    "df['dt'] = df.apply(lambda x: datetime.fromtimestamp(int(x['TIME_STAMP'])/1000),axis=1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 74,
   "metadata": {},
   "outputs": [],
   "source": [
    "g = df.groupby(['VEHICLE_ID', 'TRIP_ID'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 88,
   "metadata": {},
   "outputs": [],
   "source": [
    "df['next_value'] = df.groupby(['VEHICLE_ID', 'TRIP_ID'])['dt'].shift(-1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 89,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>TRIP_ID</th>\n",
       "      <th>VEHICLE_ID</th>\n",
       "      <th>TIME_STAMP</th>\n",
       "      <th>SIGNAL_NAME</th>\n",
       "      <th>WIRELESS_CHARGING_STATE</th>\n",
       "      <th>dt</th>\n",
       "      <th>prev_value</th>\n",
       "      <th>charging_min</th>\n",
       "      <th>next_value</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606544630505</td>\n",
       "      <td>systemEvent</td>\n",
       "      <td>NULL</td>\n",
       "      <td>2020-11-27 22:23:50.505</td>\n",
       "      <td>2020-11-27 22:24:49.247</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>2020-11-27 22:24:49.247</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606544689247</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "      <td>2020-11-27 22:24:49.247</td>\n",
       "      <td>2020-11-27 22:32:47.860</td>\n",
       "      <td>0.979033</td>\n",
       "      <td>2020-11-27 22:32:47.860</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606545167860</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>NOT_CHARGING</td>\n",
       "      <td>2020-11-27 22:32:47.860</td>\n",
       "      <td>2020-11-27 22:39:53.799</td>\n",
       "      <td>7.976883</td>\n",
       "      <td>2020-11-27 22:39:53.799</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606545593799</td>\n",
       "      <td>GeneralConnectivityService,getConnectionStatus</td>\n",
       "      <td>NULL</td>\n",
       "      <td>2020-11-27 22:39:53.799</td>\n",
       "      <td>NaT</td>\n",
       "      <td>7.098983</td>\n",
       "      <td>NaT</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606596766521</td>\n",
       "      <td>systemEvent</td>\n",
       "      <td>NULL</td>\n",
       "      <td>2020-11-28 12:52:46.521</td>\n",
       "      <td>2020-11-28 12:53:09.849</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>2020-11-28 12:53:09.849</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606596789849</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "      <td>2020-11-28 12:53:09.849</td>\n",
       "      <td>2020-11-28 12:53:14.961</td>\n",
       "      <td>0.388800</td>\n",
       "      <td>2020-11-28 12:53:14.961</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606596794961</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>NOT_CHARGING</td>\n",
       "      <td>2020-11-28 12:53:14.961</td>\n",
       "      <td>2020-11-28 12:54:25.073</td>\n",
       "      <td>0.085200</td>\n",
       "      <td>2020-11-28 12:54:25.073</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606596865073</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "      <td>2020-11-28 12:54:25.073</td>\n",
       "      <td>2020-11-28 13:30:17.374</td>\n",
       "      <td>1.168533</td>\n",
       "      <td>2020-11-28 13:30:17.374</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606599017374</td>\n",
       "      <td>ApplicationControlService,activeApplicationCha...</td>\n",
       "      <td>NULL</td>\n",
       "      <td>2020-11-28 13:30:17.374</td>\n",
       "      <td>NaT</td>\n",
       "      <td>35.871683</td>\n",
       "      <td>NaT</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  TRIP_ID VEHICLE_ID     TIME_STAMP  \\\n",
       "0    405f   0691e45b  1606544630505   \n",
       "1    405f   0691e45b  1606544689247   \n",
       "2    405f   0691e45b  1606545167860   \n",
       "3    405f   0691e45b  1606545593799   \n",
       "4    49e5   e7c89137  1606596766521   \n",
       "5    49e5   e7c89137  1606596789849   \n",
       "6    49e5   e7c89137  1606596794961   \n",
       "7    49e5   e7c89137  1606596865073   \n",
       "8    49e5   e7c89137  1606599017374   \n",
       "\n",
       "                                         SIGNAL_NAME WIRELESS_CHARGING_STATE  \\\n",
       "0                                        systemEvent                    NULL   \n",
       "1  WirelessChargingService,wirelessChargingStatus...                CHARGING   \n",
       "2  WirelessChargingService,wirelessChargingStatus...            NOT_CHARGING   \n",
       "3     GeneralConnectivityService,getConnectionStatus                    NULL   \n",
       "4                                        systemEvent                    NULL   \n",
       "5  WirelessChargingService,wirelessChargingStatus...                CHARGING   \n",
       "6  WirelessChargingService,wirelessChargingStatus...            NOT_CHARGING   \n",
       "7  WirelessChargingService,wirelessChargingStatus...                CHARGING   \n",
       "8  ApplicationControlService,activeApplicationCha...                    NULL   \n",
       "\n",
       "                       dt              prev_value  charging_min  \\\n",
       "0 2020-11-27 22:23:50.505 2020-11-27 22:24:49.247      0.000000   \n",
       "1 2020-11-27 22:24:49.247 2020-11-27 22:32:47.860      0.979033   \n",
       "2 2020-11-27 22:32:47.860 2020-11-27 22:39:53.799      7.976883   \n",
       "3 2020-11-27 22:39:53.799                     NaT      7.098983   \n",
       "4 2020-11-28 12:52:46.521 2020-11-28 12:53:09.849      0.000000   \n",
       "5 2020-11-28 12:53:09.849 2020-11-28 12:53:14.961      0.388800   \n",
       "6 2020-11-28 12:53:14.961 2020-11-28 12:54:25.073      0.085200   \n",
       "7 2020-11-28 12:54:25.073 2020-11-28 13:30:17.374      1.168533   \n",
       "8 2020-11-28 13:30:17.374                     NaT     35.871683   \n",
       "\n",
       "               next_value  \n",
       "0 2020-11-27 22:24:49.247  \n",
       "1 2020-11-27 22:32:47.860  \n",
       "2 2020-11-27 22:39:53.799  \n",
       "3                     NaT  \n",
       "4 2020-11-28 12:53:09.849  \n",
       "5 2020-11-28 12:53:14.961  \n",
       "6 2020-11-28 12:54:25.073  \n",
       "7 2020-11-28 13:30:17.374  \n",
       "8                     NaT  "
      ]
     },
     "execution_count": 89,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 90,
   "metadata": {},
   "outputs": [],
   "source": [
    "df['charging_min'] = df.apply(lambda x: (x['next_value'] - x['dt']).total_seconds()/60, axis=1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 91,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>TRIP_ID</th>\n",
       "      <th>VEHICLE_ID</th>\n",
       "      <th>TIME_STAMP</th>\n",
       "      <th>SIGNAL_NAME</th>\n",
       "      <th>WIRELESS_CHARGING_STATE</th>\n",
       "      <th>dt</th>\n",
       "      <th>prev_value</th>\n",
       "      <th>charging_min</th>\n",
       "      <th>next_value</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606544630505</td>\n",
       "      <td>systemEvent</td>\n",
       "      <td>NULL</td>\n",
       "      <td>2020-11-27 22:23:50.505</td>\n",
       "      <td>2020-11-27 22:24:49.247</td>\n",
       "      <td>0.979033</td>\n",
       "      <td>2020-11-27 22:24:49.247</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606544689247</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "      <td>2020-11-27 22:24:49.247</td>\n",
       "      <td>2020-11-27 22:32:47.860</td>\n",
       "      <td>7.976883</td>\n",
       "      <td>2020-11-27 22:32:47.860</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606545167860</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>NOT_CHARGING</td>\n",
       "      <td>2020-11-27 22:32:47.860</td>\n",
       "      <td>2020-11-27 22:39:53.799</td>\n",
       "      <td>7.098983</td>\n",
       "      <td>2020-11-27 22:39:53.799</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606545593799</td>\n",
       "      <td>GeneralConnectivityService,getConnectionStatus</td>\n",
       "      <td>NULL</td>\n",
       "      <td>2020-11-27 22:39:53.799</td>\n",
       "      <td>NaT</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaT</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606596766521</td>\n",
       "      <td>systemEvent</td>\n",
       "      <td>NULL</td>\n",
       "      <td>2020-11-28 12:52:46.521</td>\n",
       "      <td>2020-11-28 12:53:09.849</td>\n",
       "      <td>0.388800</td>\n",
       "      <td>2020-11-28 12:53:09.849</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606596789849</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "      <td>2020-11-28 12:53:09.849</td>\n",
       "      <td>2020-11-28 12:53:14.961</td>\n",
       "      <td>0.085200</td>\n",
       "      <td>2020-11-28 12:53:14.961</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606596794961</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>NOT_CHARGING</td>\n",
       "      <td>2020-11-28 12:53:14.961</td>\n",
       "      <td>2020-11-28 12:54:25.073</td>\n",
       "      <td>1.168533</td>\n",
       "      <td>2020-11-28 12:54:25.073</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606596865073</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "      <td>2020-11-28 12:54:25.073</td>\n",
       "      <td>2020-11-28 13:30:17.374</td>\n",
       "      <td>35.871683</td>\n",
       "      <td>2020-11-28 13:30:17.374</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606599017374</td>\n",
       "      <td>ApplicationControlService,activeApplicationCha...</td>\n",
       "      <td>NULL</td>\n",
       "      <td>2020-11-28 13:30:17.374</td>\n",
       "      <td>NaT</td>\n",
       "      <td>NaN</td>\n",
       "      <td>NaT</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  TRIP_ID VEHICLE_ID     TIME_STAMP  \\\n",
       "0    405f   0691e45b  1606544630505   \n",
       "1    405f   0691e45b  1606544689247   \n",
       "2    405f   0691e45b  1606545167860   \n",
       "3    405f   0691e45b  1606545593799   \n",
       "4    49e5   e7c89137  1606596766521   \n",
       "5    49e5   e7c89137  1606596789849   \n",
       "6    49e5   e7c89137  1606596794961   \n",
       "7    49e5   e7c89137  1606596865073   \n",
       "8    49e5   e7c89137  1606599017374   \n",
       "\n",
       "                                         SIGNAL_NAME WIRELESS_CHARGING_STATE  \\\n",
       "0                                        systemEvent                    NULL   \n",
       "1  WirelessChargingService,wirelessChargingStatus...                CHARGING   \n",
       "2  WirelessChargingService,wirelessChargingStatus...            NOT_CHARGING   \n",
       "3     GeneralConnectivityService,getConnectionStatus                    NULL   \n",
       "4                                        systemEvent                    NULL   \n",
       "5  WirelessChargingService,wirelessChargingStatus...                CHARGING   \n",
       "6  WirelessChargingService,wirelessChargingStatus...            NOT_CHARGING   \n",
       "7  WirelessChargingService,wirelessChargingStatus...                CHARGING   \n",
       "8  ApplicationControlService,activeApplicationCha...                    NULL   \n",
       "\n",
       "                       dt              prev_value  charging_min  \\\n",
       "0 2020-11-27 22:23:50.505 2020-11-27 22:24:49.247      0.979033   \n",
       "1 2020-11-27 22:24:49.247 2020-11-27 22:32:47.860      7.976883   \n",
       "2 2020-11-27 22:32:47.860 2020-11-27 22:39:53.799      7.098983   \n",
       "3 2020-11-27 22:39:53.799                     NaT           NaN   \n",
       "4 2020-11-28 12:52:46.521 2020-11-28 12:53:09.849      0.388800   \n",
       "5 2020-11-28 12:53:09.849 2020-11-28 12:53:14.961      0.085200   \n",
       "6 2020-11-28 12:53:14.961 2020-11-28 12:54:25.073      1.168533   \n",
       "7 2020-11-28 12:54:25.073 2020-11-28 13:30:17.374     35.871683   \n",
       "8 2020-11-28 13:30:17.374                     NaT           NaN   \n",
       "\n",
       "               next_value  \n",
       "0 2020-11-27 22:24:49.247  \n",
       "1 2020-11-27 22:32:47.860  \n",
       "2 2020-11-27 22:39:53.799  \n",
       "3                     NaT  \n",
       "4 2020-11-28 12:53:09.849  \n",
       "5 2020-11-28 12:53:14.961  \n",
       "6 2020-11-28 12:54:25.073  \n",
       "7 2020-11-28 13:30:17.374  \n",
       "8                     NaT  "
      ]
     },
     "execution_count": 91,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 92,
   "metadata": {},
   "outputs": [],
   "source": [
    "df_filt = df[df.WIRELESS_CHARGING_STATE == 'CHARGING']"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 93,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>TRIP_ID</th>\n",
       "      <th>VEHICLE_ID</th>\n",
       "      <th>TIME_STAMP</th>\n",
       "      <th>SIGNAL_NAME</th>\n",
       "      <th>WIRELESS_CHARGING_STATE</th>\n",
       "      <th>dt</th>\n",
       "      <th>prev_value</th>\n",
       "      <th>charging_min</th>\n",
       "      <th>next_value</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>405f</td>\n",
       "      <td>0691e45b</td>\n",
       "      <td>1606544689247</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "      <td>2020-11-27 22:24:49.247</td>\n",
       "      <td>2020-11-27 22:32:47.860</td>\n",
       "      <td>7.976883</td>\n",
       "      <td>2020-11-27 22:32:47.860</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606596789849</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "      <td>2020-11-28 12:53:09.849</td>\n",
       "      <td>2020-11-28 12:53:14.961</td>\n",
       "      <td>0.085200</td>\n",
       "      <td>2020-11-28 12:53:14.961</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>49e5</td>\n",
       "      <td>e7c89137</td>\n",
       "      <td>1606596865073</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "      <td>2020-11-28 12:54:25.073</td>\n",
       "      <td>2020-11-28 13:30:17.374</td>\n",
       "      <td>35.871683</td>\n",
       "      <td>2020-11-28 13:30:17.374</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  TRIP_ID VEHICLE_ID     TIME_STAMP  \\\n",
       "1    405f   0691e45b  1606544689247   \n",
       "5    49e5   e7c89137  1606596789849   \n",
       "7    49e5   e7c89137  1606596865073   \n",
       "\n",
       "                                         SIGNAL_NAME WIRELESS_CHARGING_STATE  \\\n",
       "1  WirelessChargingService,wirelessChargingStatus...                CHARGING   \n",
       "5  WirelessChargingService,wirelessChargingStatus...                CHARGING   \n",
       "7  WirelessChargingService,wirelessChargingStatus...                CHARGING   \n",
       "\n",
       "                       dt              prev_value  charging_min  \\\n",
       "1 2020-11-27 22:24:49.247 2020-11-27 22:32:47.860      7.976883   \n",
       "5 2020-11-28 12:53:09.849 2020-11-28 12:53:14.961      0.085200   \n",
       "7 2020-11-28 12:54:25.073 2020-11-28 13:30:17.374     35.871683   \n",
       "\n",
       "               next_value  \n",
       "1 2020-11-27 22:32:47.860  \n",
       "5 2020-11-28 12:53:14.961  \n",
       "7 2020-11-28 13:30:17.374  "
      ]
     },
     "execution_count": 93,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df_filt"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 104,
   "metadata": {},
   "outputs": [],
   "source": [
    "summed_by_trip = df_filt.groupby(['VEHICLE_ID', 'TRIP_ID']).charging_min.sum().reset_index()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 98,
   "metadata": {},
   "outputs": [],
   "source": [
    "import numpy as np"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 112,
   "metadata": {},
   "outputs": [],
   "source": [
    "total_duration_by_id = df.groupby(['VEHICLE_ID','TRIP_ID']).agg({'dt':np.ptp}).reset_index().rename(columns={'dt':'trip_durn'})"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 114,
   "metadata": {},
   "outputs": [],
   "source": [
    "total_duration_by_id['trip_durn_min'] = total_duration_by_id.apply(lambda x: x['trip_durn'].total_seconds()/60,axis=1)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 118,
   "metadata": {},
   "outputs": [],
   "source": [
    "merged = pd.merge(total_duration_by_id, df_filt)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 119,
   "metadata": {},
   "outputs": [],
   "source": [
    "merged['pct_engagement'] = merged['charging_min']/merged['trip_durn_min']"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 120,
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>VEHICLE_ID</th>\n",
       "      <th>TRIP_ID</th>\n",
       "      <th>trip_durn</th>\n",
       "      <th>trip_durn_min</th>\n",
       "      <th>TIME_STAMP</th>\n",
       "      <th>SIGNAL_NAME</th>\n",
       "      <th>WIRELESS_CHARGING_STATE</th>\n",
       "      <th>dt</th>\n",
       "      <th>prev_value</th>\n",
       "      <th>charging_min</th>\n",
       "      <th>next_value</th>\n",
       "      <th>pct_engagement</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>0691e45b</td>\n",
       "      <td>405f</td>\n",
       "      <td>00:16:03.294000</td>\n",
       "      <td>16.054900</td>\n",
       "      <td>1606544689247</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "      <td>2020-11-27 22:24:49.247</td>\n",
       "      <td>2020-11-27 22:32:47.860</td>\n",
       "      <td>7.976883</td>\n",
       "      <td>2020-11-27 22:32:47.860</td>\n",
       "      <td>0.496850</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>e7c89137</td>\n",
       "      <td>49e5</td>\n",
       "      <td>00:37:30.853000</td>\n",
       "      <td>37.514217</td>\n",
       "      <td>1606596789849</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "      <td>2020-11-28 12:53:09.849</td>\n",
       "      <td>2020-11-28 12:53:14.961</td>\n",
       "      <td>0.085200</td>\n",
       "      <td>2020-11-28 12:53:14.961</td>\n",
       "      <td>0.002271</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>e7c89137</td>\n",
       "      <td>49e5</td>\n",
       "      <td>00:37:30.853000</td>\n",
       "      <td>37.514217</td>\n",
       "      <td>1606596865073</td>\n",
       "      <td>WirelessChargingService,wirelessChargingStatus...</td>\n",
       "      <td>CHARGING</td>\n",
       "      <td>2020-11-28 12:54:25.073</td>\n",
       "      <td>2020-11-28 13:30:17.374</td>\n",
       "      <td>35.871683</td>\n",
       "      <td>2020-11-28 13:30:17.374</td>\n",
       "      <td>0.956216</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "  VEHICLE_ID TRIP_ID       trip_durn  trip_durn_min     TIME_STAMP  \\\n",
       "0   0691e45b    405f 00:16:03.294000      16.054900  1606544689247   \n",
       "1   e7c89137    49e5 00:37:30.853000      37.514217  1606596789849   \n",
       "2   e7c89137    49e5 00:37:30.853000      37.514217  1606596865073   \n",
       "\n",
       "                                         SIGNAL_NAME WIRELESS_CHARGING_STATE  \\\n",
       "0  WirelessChargingService,wirelessChargingStatus...                CHARGING   \n",
       "1  WirelessChargingService,wirelessChargingStatus...                CHARGING   \n",
       "2  WirelessChargingService,wirelessChargingStatus...                CHARGING   \n",
       "\n",
       "                       dt              prev_value  charging_min  \\\n",
       "0 2020-11-27 22:24:49.247 2020-11-27 22:32:47.860      7.976883   \n",
       "1 2020-11-28 12:53:09.849 2020-11-28 12:53:14.961      0.085200   \n",
       "2 2020-11-28 12:54:25.073 2020-11-28 13:30:17.374     35.871683   \n",
       "\n",
       "               next_value  pct_engagement  \n",
       "0 2020-11-27 22:32:47.860        0.496850  \n",
       "1 2020-11-28 12:53:14.961        0.002271  \n",
       "2 2020-11-28 13:30:17.374        0.956216  "
      ]
     },
     "execution_count": 120,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "merged"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.6.4"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
